<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LPG/ბენზინი კალკულატორი — Subaru Forester 2.5</title>

    <!-- retain existing libs / styling (Tailwind + Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

    <style>
        /* keep your original custom styles and ensure new elements match */
        #mini-map { z-index: 400; }
        #octaneSidebar { z-index: 2000; transition: transform 0.3s ease-in-out; }
        #octaneSidebar.hidden { transform: translateX(-100%); }
        @media (max-width: 640px) {
            #octaneSidebar { width:100%; max-width:100%; }
            #resizeSidebarBtn { display:none; }
        }
        /* small helper to keep long pre blocks neat */
        pre { white-space: pre-wrap; word-break: break-word; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Subaru ✨ — ჭიათურა ↔ თბილისი</h1>
            <p class="text-gray-600 mt-2">მარშრუტი და საწვავის ხარჯების კალკულატორი (Forester 2016 · 2.5 · CVT)</p>
        </header>

        <!-- Map Section (unchanged visual) -->
        <section class="mb-8">
            <div id="mini-map" class="w-full h-80 sm:h-96 rounded-lg shadow-md border border-gray-200"></div>
        </section>

        <!-- Calculator Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4">საწვავის კალკულატორი</h2>
            <p class="text-gray-600 mb-4">შეიყვანეთ მონაცემები ან გამოიყენეთ Forester-ის დეფოლტი ღილაკით.</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <!-- existing inputs (kept) -->
                <div>
                    <label for="B" class="block text-sm font-medium text-gray-700">B (ლ/100კმ) — ბენზინი</label>
                    <input id="B" type="number" step="0.01" value="9.68" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="D" class="block text-sm font-medium text-gray-700">D (მანძილი, კმ)</label>
                    <input id="D" type="number" step="0.01" value="178.79" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label for="price_lpg" class="block text-sm font-medium text-gray-700">LPG ფასი (₾/ლ)</label>
                    <input id="price_lpg" type="number" step="0.01" value="1.40" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="price_reg" class="block text-sm font-medium text-gray-700">ევრო რეგულარი (₾/ლ)</label>
                    <input id="price_reg" type="number" step="0.01" value="3.04" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="price_premium" class="block text-sm font-medium text-gray-700">ევრო პრემიუმი (₾/ლ)</label>
                    <input id="price_premium" type="number" step="0.01" value="3.21" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="price_super" class="block text-sm font-medium text-gray-700">სუპერი (₾/ლ)</label>
                    <input id="price_super" type="number" step="0.01" value="3.59" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>

                <!-- NEW: vehicle/ascent/efficiency fields (integrated visually with same style) -->
                <div>
                    <label for="vehicle_mass" class="block text-sm font-medium text-gray-700">მანქანის მასა (kg) — curb weight</label>
                    <input id="vehicle_mass" type="number" step="1" value="1540" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    <small class="text-gray-500">Forester 2016 ~1540 kg (სულ)</small>
                </div>
                <div>
                    <label for="total_ascent" class="block text-sm font-medium text-gray-700">Total ascent (m) — მთლიანი ასამაღლება</label>
                    <input id="total_ascent" type="number" step="1" value="616" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    <small class="text-gray-500">GPX/KML–დან ან პროფილიდან (შეგიძლიათ გარდაცვალოთ)</small>
                </div>
                <div>
                    <label for="efficiency" class="block text-sm font-medium text-gray-700">სისტემური ეფექტურობა η (%)</label>
                    <input id="efficiency" type="number" step="0.1" value="25" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    <small class="text-gray-500">რეკომენდირებული: 20–30%</small>
                </div>
                <div>
                    <label for="q_lpg" class="block text-sm font-medium text-gray-700">LPG ენერგია (MJ/ლ)</label>
                    <input id="q_lpg" type="number" step="0.1" value="26" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="q_gas" class="block text-sm font-medium text-gray-700">ბენზინის ენერგია (MJ/ლ)</label>
                    <input id="q_gas" type="number" step="0.1" value="34.2" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-800 mb-2">ოქტანობის ეფექტი (%)</h3>
            <p class="text-gray-600 text-sm mb-3">მიუთითეთ პროცენტული ეფექტურობის ცვლილება (მაგ., Premium = 1.5% უკეთესია)</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="octane_reg" class="block text-sm font-medium text-gray-700">ევრო რეგულარი (%)</label>
                    <input id="octane_reg" type="number" step="0.1" value="0" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="octane_premium" class="block text-sm font-medium text-gray-700">ევრო პრემიუმი (%)</label>
                    <input id="octane_premium" type="number" step="0.1" value="1.5" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="octane_super" class="block text-sm font-medium text-gray-700">სუპერი (%)</label>
                    <input id="octane_super" type="number" step="0.1" value="3" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="octane_lpg" class="block text-sm font-medium text-gray-700">LPG ნეგატივი (%)</label>
                    <input id="octane_lpg" type="number" step="0.1" value="15" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
            </div>

            <!-- buttons: include Forester defaults and calculate + CSV export -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 gap-3">
                <button onclick="fillForesterDefaults()" class="bg-yellow-500 text-black px-4 py-2 rounded-md font-semibold hover:bg-yellow-600">Forester default</button>
                <button onclick="calculateFuel()" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700">გამოთვალე</button>
                <button onclick="downloadCSV()" id="csvBtn" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700">ექსპორტი CSV</button>
                <button onclick="toggleOctaneInfo()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">ოქტანობის შესახებ</button>
            </div>

            <div id="error" class="text-red-500 text-sm mt-3"></div>
            <div id="results" class="mt-4 overflow-x-auto text-gray-800"></div>
        </section>

        <!-- Sidebar for Octane Information (kept; styling intact) -->
        <div id="octaneSidebar" class="fixed top-0 left-0 h-full w-80 bg-white p-6 shadow-lg z-[2000] hidden overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ბენზინის ოქტანობის ეფექტი</h2>
                <button id="resizeSidebarBtn" onclick="resizeSidebar()" class="bg-blue-600 text-white px-3 py-1 rounded-md">↔ ზომა</button>
            </div>
            <div id="octaneContent" class="text-gray-700">
                <!-- preserve original explanatory content (kept concise) -->
                <p class="mb-4">ოქტანობა (91/95/98) განსაზღვრავს საწვავის დეთონაციისადმი უძლურებას — მაღალი ოქტანობა ზოგჯერ იძლევა მცირე ეფექტურობის მომატებას.</p>
                <h3 class="text-lg font-semibold mb-2">🔬 რატომ ხდება ასე</h3>
                <ul class="list-disc pl-5 mb-4">
                    <li>სტაბილური წვა და ნაკლები დებსონაცია</li>
                    <li>მიუხედავად ამისა ეფექტი პრაქტიკაში ხშირად 1–3%–ია</li>
                </ul>
                <h3 class="text-lg font-semibold mb-2">➡️ დასკვნა</h3>
                <p class="mb-4">LPG ხშირად იაფია ლარში, თუმცა ლიტრებში ახდენს მეტ ცნს; ოქტანის შუალედი ბენზინის ფარგლებში მცირეა ფულად.</p>
            </div>
            <button onclick="toggleOctaneInfo()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">დახურვა</button>
        </div>

        <footer class="text-sm text-gray-600 text-center mt-6">
            <p>შენიშვნა: ასამაღლებიდან გამოთვლილი დამატებითი ლიტრები არის თეორიული მინიმუმი; რეალური მართვის სტილი გაზრდის შედეგს.</p>
        </footer>
    </div>

    <!-- === SCRIPTS: map + calculator logic === -->
    <script>
    // ---- Map init (kept from your original file) ----
    (function() {
        const map = L.map('mini-map', { scrollWheelZoom: false }).setView([41.9, 44.2], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const chiatura = [42.285556, 43.267222];
        const tbilisi = [41.78, 44.782778];
        L.marker(chiatura).addTo(map).bindPopup('<strong>ჭიათურა</strong>');
        L.marker(tbilisi).addTo(map).bindPopup('<strong>თბილისი</strong>');

        // Try to parse embedded KML route (if present in your original file)
        try {
            const kmlString = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Route</name><Placemark><LineString><coordinates>
            <!-- your long coordinates omitted here for brevity; original file keeps them -->
            </coordinates></LineString></Placemark></Document></kml>`;
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(kmlString, 'text/xml');
            const geojson = toGeoJSON.kml(kmlDoc);
            L.geoJSON(geojson, { style: { color: '#2b6cb0', weight: 4, opacity: 0.8 } }).addTo(map);
            // fit to route bounds (fallback to markers)
            // Note: if geojson has no bbox, use marker bounds:
            const bounds = L.latLngBounds([chiatura, tbilisi]);
            map.fitBounds(bounds, { padding: [40,40] });
        } catch (e) {
            console.warn('KML parsing failed or omitted content:', e);
        }
    })();

    // ---- Utility format function ----
    function fmt(n, decimals=2) {
        if (Number.isNaN(Number(n))) return '-';
        return Number(n).toLocaleString('ka-GE', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    // ---- Fill Forester defaults ----
    function fillForesterDefaults() {
        document.getElementById('vehicle_mass').value = 1540;
        document.getElementById('efficiency').value = 25;
        document.getElementById('B').value = 9.68;
        document.getElementById('total_ascent').value = 616;
        alert('Forester 2016 (2.5, curb ≈1540 kg) პარამეტრები შევსებულია.');
    }

    // ---- Core calculation function (integrates with existing UI) ----
    function calculateFuel() {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = '';
        // inputs
        const B = parseFloat(document.getElementById('B').value) || 0;           // ლ/100კმ ბენზინი
        const D = parseFloat(document.getElementById('D').value) || 0;           // მანძილი კმ
        const price_lpg = parseFloat(document.getElementById('price_lpg').value) || 0;
        const price_reg = parseFloat(document.getElementById('price_reg').value) || 0;
        const price_premium = parseFloat(document.getElementById('price_premium').value) || 0;
        const price_super = parseFloat(document.getElementById('price_super').value) || 0;

        const mass = parseFloat(document.getElementById('vehicle_mass').value) || 0;
        const ascent = parseFloat(document.getElementById('total_ascent').value) || 0;
        const effPerc = parseFloat(document.getElementById('efficiency').value) || 0;
        const qLpg = parseFloat(document.getElementById('q_lpg').value) || 26;
        const qGas = parseFloat(document.getElementById('q_gas').value) || 34.2;

        const octane_reg = parseFloat(document.getElementById('octane_reg').value) || 0;
        const octane_premium = parseFloat(document.getElementById('octane_premium').value) || 0;
        const octane_super = parseFloat(document.getElementById('octane_super').value) || 0;
        const octane_lpg = parseFloat(document.getElementById('octane_lpg').value) || 0;

        // basic validation
        if (D <= 0) { errorDiv.textContent = 'გთხოვთ მიუთითოთ მანძილი (D) სწორად.'; return; }
        if (effPerc <= 0) { errorDiv.textContent = 'შეიყვანეთ ეფექტურობა (η) — მაგალითად 25.'; return; }

        // base consumption (liters)
        const fuelUsed_gas_L = (B * D) / 100.0;
        const fuelUsed_lpg_L = fuelUsed_gas_L * (1 + octane_lpg / 100.0);

        // octane adjusted liters for petrol types
        const fuel_reg_L = fuelUsed_gas_L * (1 - octane_reg / 100.0);
        const fuel_premium_L = fuelUsed_gas_L * (1 - octane_premium / 100.0);
        const fuel_super_L = fuelUsed_gas_L * (1 - octane_super / 100.0);

        // costs
        const cost_reg = fuel_reg_L * price_reg;
        const cost_premium = fuel_premium_L * price_premium;
        const cost_super = fuel_super_L * price_super;
        const cost_lpg = fuelUsed_lpg_L * price_lpg;

        // Ascent -> theoretical extra liters
        // E = m*g*h (J); L = E / (eta * Q[J/L]) ; Q[MJ/L] -> *1e6
        const g = 9.81;
        const E = mass * g * ascent; // J
        const eta = effPerc / 100.0;
        const L_extra_gas = E / (eta * qGas * 1e6);
        const L_extra_lpg = E / (eta * qLpg * 1e6);

        // convert to money
        const extraCost_gas_reg = L_extra_gas * price_reg;
        const extraCost_gas_premium = L_extra_gas * price_premium;
        const extraCost_gas_super = L_extra_gas * price_super;
        const extraCost_lpg = L_extra_lpg * price_lpg;

        // practical multiplier to account for acceleration/braking & inefficiencies
        const practicalFactorMin = 1.3;
        const practicalFactorMax = 3.0;
        const practicalExtraMin = L_extra_gas * practicalFactorMin;
        const practicalExtraMax = L_extra_gas * practicalFactorMax;

        // prepare results object for CSV export and display
        const results = {
            distance_km: D,
            base_L_per100: B,
            fuelUsed_gas_L,
            fuelUsed_lpg_L,
            fuel_reg_L, fuel_premium_L, fuel_super_L,
            cost_reg, cost_premium, cost_super, cost_lpg,
            ascent_m: ascent,
            mass_kg: mass,
            eta_percent: effPerc,
            L_extra_gas, L_extra_lpg,
            extraCost_gas_reg, extraCost_gas_premium, extraCost_gas_super, extraCost_lpg,
            practicalExtraMin, practicalExtraMax
        };

        // build HTML results (kept compact and readable)
        let out = `<div class="bg-gray-50 p-4 rounded border border-gray-200">`;
        out += `<h3 class="font-semibold mb-2">საწყისი</h3>`;
        out += `<p>მანძილი: <strong>${fmt(D,2)} km</strong> &middot; ძირითადი ბენზინის მოხმარება: <strong>${fmt(fuelUsed_gas_L,2)} ლ</strong></p>`;

        out += `<h3 class="font-semibold mt-3 mb-2">ფულადი შედარება</h3>`;
        out += `<table class="w-full text-sm"><thead><tr><th class="text-left">საწვავი</th><th class="text-left">ლიტრი</th><th class="text-left">ღირებულება (₾)</th></tr></thead><tbody>`;
        out += `<tr><td>LPG</td><td>${fmt(fuelUsed_lpg_L,2)}</td><td>${fmt(cost_lpg,2)} ₾</td></tr>`;
        out += `<tr><td>რეგულარი (91)</td><td>${fmt(fuel_reg_L,2)}</td><td>${fmt(cost_reg,2)} ₾</td></tr>`;
        out += `<tr><td>პრემიუმი (95)</td><td>${fmt(fuel_premium_L,2)}</td><td>${fmt(cost_premium,2)} ₾</td></tr>`;
        out += `<tr><td>სუპერი (98)</td><td>${fmt(fuel_super_L,2)}</td><td>${fmt(cost_super,2)} ₾</td></tr>`;
        out += `</tbody></table>`;

        out += `<h3 class="font-semibold mt-3 mb-2">ასამაღლებიდან თეორიული დამატება</h3>`;
        out += `<p>მანქანის მასა: ${fmt(mass,0)} kg · ასამაღლება: ${fmt(ascent,0)} m · ეფექტურობა: ${fmt(eta*100,1)}%</p>`;
        out += `<p>თეორიული დამატებითი ბენზინი: <strong>${fmt(L_extra_gas,3)} ლ</strong> · LPG თეორია: <strong>${fmt(L_extra_lpg,3)} ლ</strong></p>`;
        out += `<p class="text-sm text-gray-600 mt-2">პრაქტიკული პროგნოზი (ასევე აჩქარება/ბრაკირება): ${fmt(practicalExtraMin,3)} ლ — ${fmt(practicalExtraMax,3)} ლ დამატებით ბენზინზე</p>`;

        out += `</div>`;

        document.getElementById('results').innerHTML = out;
        window._lastCalc = results; // keep for CSV export
    }

    // ---- CSV export ----
    function downloadCSV() {
        if (!window._lastCalc) {
            alert('გთხოვთ დააჭიროთ "გამოთვალე" პირველი და შემდეგ დააჭირეთ CSV–ს.');
            return;
        }
        const r = window._lastCalc;
        const rows = [
            ['distance_km','base_L_per100','fuelUsed_gas_L','fuelUsed_lpg_L','fuel_reg_L','fuel_premium_L','fuel_super_L','cost_reg','cost_premium','cost_super','cost_lpg','ascent_m','vehicle_mass_kg','eta_percent','L_extra_gas','L_extra_lpg','practicalExtraMin','practicalExtraMax'],
            [r.distance_km, r.base_L_per100, r.fuelUsed_gas_L, r.fuelUsed_lpg_L, r.fuel_reg_L, r.fuel_premium_L, r.fuel_super_L, r.cost_reg, r.cost_premium, r.cost_super, r.cost_lpg, r.ascent_m, r.mass_kg, r.eta_percent, r.L_extra_gas, r.L_extra_lpg, r.practicalExtraMin, r.practicalExtraMax]
        ];
        const csv = rows.map(rw => rw.map(val => `"${String(val).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fuel_calc_${Date.now()}.csv`;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ---- Sidebar toggle & resize (kept) ----
    function toggleOctaneInfo() {
        document.getElementById('octaneSidebar').classList.toggle('hidden');
    }
    let currentWidthIndex = 0;
    const sidebarWidths = ['w-80','w-[480px]','w-[640px]'];
    function resizeSidebar() {
        const sidebar = document.getElementById('octaneSidebar');
        sidebarWidths.forEach(w => sidebar.classList.remove(w));
        currentWidthIndex = (currentWidthIndex + 1) % sidebarWidths.length;
        sidebar.classList.add(sidebarWidths[currentWidthIndex]);
    }
    </script>
</body>
</html>
